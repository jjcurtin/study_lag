{
  "hash": "28d1e652b685d639d354c7ceb59985b7",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Evaluate model performance\"\nauthor: \"Kendra Wyant\"\ndate: \"2025-06-06\"\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\neditor_options: \n  chunk_output_type: console\n---\n\n\n\n## Set Up Environment\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\n# handle conflicts\noptions(conflicts.policy = \"depends.ok\")\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/fun_ml.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"32a0bc8ced92c79756b56ddcdc9a06e639795da6\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\ntidymodels_conflictRules()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nsuppressPackageStartupMessages(library(tidyverse))\nsuppressPackageStartupMessages(library(tidymodels))\nsuppressPackageStartupMessages(library(tidyposterior))\nlibrary(kableExtra, exclude = \"group_rows\")\nlibrary(Rcpp, exclude = \"populate\")\nlibrary(brms, exclude = c(\"ar\", \"mixture\"))\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nLoading 'brms' package (version 2.22.0). Useful instructions\ncan be found by typing help('brms'). A more detailed introduction\nto the package is available through vignette('brms_overview').\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nlibrary(patchwork)\n\n\ntheme_set(theme_classic()) \n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| output: false\n\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"de12d764438078a9341db9bc0b2472c87e0ae846\"\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\n#| output: false\n\n# CHTC support functions\ndevtools::source_url(\"https://github.com/jjcurtin/lab_support/blob/main/chtc/static_files/fun_chtc.R?raw=true\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nℹ SHA-1 hash of file is \"6112ad4934c18197bb71037f5d65b97e1fd2b039\"\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npath_models_lag <- format_path(str_c(\"studydata/risk/models/lag\"))\npath_processed <- format_path(str_c(\"studydata/risk/data_processed/lag\"))\n```\n:::\n\n\n\n\n## Read in Data\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nauroc_0 <- read_csv(here::here(path_models_lag, \n                                   \"test_auroc_6_x_5_1day_0_v3_nested_strat_lh.csv\"),\n                      col_types = cols()) \n\n\nprobs_0 <- read_rds(here::here(path_models_lag, \"outer_preds_6_x_5_1day_0_v3_nested_strat_lh.rds\"))\n\nauroc_0_dem <- read_csv(here::here(path_models_lag, \n                                   \"test_auroc_6_x_5_1day_0_v3_nested_strat_lh_fairness.csv\"),\n                      col_types = cols()) \n\nfeat <- read_csv(here::here(path_processed, str_c(\"features_0lag_v3.csv\")),\n                 col_types = cols()) |> \n  select(label_num, subid, dttm_label, lapse, demo_age, demo_sex, demo_income, demo_race) |> \n  arrange(label_num) \n\npp_tidy_dem <- read_csv(here::here(path_models_lag, \"posteriors_dem.csv\"), \n                        show_col_types = FALSE) |> \n  mutate(lag = factor(lag, levels = c(0, 336),\n                      labels = c(\"No lag\", \"2 weeks\")),\n         model = factor(model)) |> \n  mutate(group = case_when(model %in% c(\"female\", \"male\") ~ \"Sex (female, male)\",\n                           model %in% c(\"not white\", \"non-hispanic white\") ~ \"Race (not White, White)\",\n                           model %in% c(\"below poverty\", \"above poverty\") ~ \"Income (below poverty, above poverty)\")) |> \n  filter(!is.na(lag))\n\nci_dem <- read_csv(here::here(path_models_lag, \"pp_dem_all.csv\"), \n                   show_col_types = FALSE) |> \n  mutate(lag = factor(lag, levels = c(0, 336),\n                      labels = c(\"No lag\", \"2 weeks\")),\n         model = factor(model)) |> \n  mutate(group = case_when(model %in% c(\"female\", \"male\") ~ \"Sex (female, male)\",\n                           model %in% c(\"not white\", \"non-hispanic white\") ~ \"Race (not White, White)\",\n                           model %in% c(\"below poverty\", \"above poverty\") ~ \"Income (below poverty, above poverty)\")) |> \n  filter(!is.na(lag))\n```\n:::\n\n\n\n## No Lag Model\n\n\n### Overall performance\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmedian(auroc_0$roc_auc)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.9113233\n```\n\n\n:::\n:::\n\n\n\n### Probabilities\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nhist(probs_0$prob_raw)\n```\n\n::: {.cell-output-display}\n![](eval_model_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n### Calibration\n\nUsing beta calibration without issues\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbin_width = 0.10\n\nprobs_0 |> \n  mutate(bins = cut(prob_logi, breaks = seq(0, 1, bin_width)), \n         lapse = if_else(label == \"Lapse\", 1, 0)) |> \n  group_by(bins)  |> \n  summarize(mean_lapse = mean(lapse),\n            .groups = \"drop\") |>\n  mutate(bins = as.numeric(bins),\n         midpoints = bin_width/2 + bin_width * (bins - 1))  |> \n  ggplot(data = _, aes(x = midpoints, y = mean_lapse)) +\n  geom_abline(slope = 1, intercept = 0, linetype = \"dotted\") +\n  geom_line() +\n  geom_point() +\n  labs(x = \"Predicted Lapse Probability (bin mid-point)\",\n       y = \"Observed Lapse Probability\") +\n  scale_x_continuous(breaks = seq(0, 1, bin_width),\n                     limits = c(0, 1)) +\n  scale_y_continuous(breaks = seq(0, 1, bin_width),\n                     limits = c(0, 1)) \n```\n\n::: {.cell-output-display}\n![](eval_model_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n### Fairness\nOnly one fold missing\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nnaniar::miss_var_summary(auroc_0_dem)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 7 × 3\n  variable        n_miss pct_miss\n  <chr>            <int>    <num>\n1 not white            1     3.33\n2 outer_split_num      0     0   \n3 female               0     0   \n4 male                 0     0   \n5 white                0     0   \n6 above poverty        0     0   \n7 below poverty        0     0   \n```\n\n\n:::\n:::\n\n\n\nmedian auroc for groups\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nauroc_0_dem |> \n  summarise(across(c(female:`below poverty`), ~median(.x, na.rm = TRUE)))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 6\n  female  male `not white` white `above poverty` `below poverty`\n   <dbl> <dbl>       <dbl> <dbl>           <dbl>           <dbl>\n1  0.893 0.928       0.832 0.914           0.910           0.901\n```\n\n\n:::\n:::\n\n\n\nProblem is a few folds in Not White condition are extra low\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nauroc_0_dem |> \n  ggplot(aes(x = `not white`)) +\n  geom_histogram(fill = \"light grey\", color = \"black\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: Removed 1 row containing non-finite outside the scale range\n(`stat_bin()`).\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](eval_model_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\nLook at breakdown of groups in splits with low auROC\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfeat_preds <- feat |> \n  mutate(label = if_else(lapse == \"yes\", \"Lapse\", \"No lapse\"),\n         id_obs = label_num) |>\n  right_join(probs_0, by = c(\"id_obs\", \"label\")) |> \n  select(-c(label_num, lapse)) |> \n  mutate(label = factor(label, levels = c(\"Lapse\", \"No lapse\")))\n\nfeat_preds <- feat_preds |> \n  mutate(demo_sex = if_else(demo_sex == \"Female\", \"female\", \"male\"),\n         demo_race = if_else(demo_race == \"White/Caucasian\", \"white\", \"not white\"),\n         demo_income = if_else(demo_income < 15060, \"below poverty\", \"above poverty\"))\n```\n:::\n\n\n\nSplits below .5\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n(outer_splits <- auroc_0_dem |> \n  filter(`not white` < .5) |> \n  pull(outer_split_num))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1]  4  9 23\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nfeat_preds |> \n  filter(outer_split_num %in% outer_splits) |> \n  group_by(subid, outer_split_num) |> \n  slice_head(n = 1) |> \n  ungroup() |> \n  count(outer_split_num, demo_race) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n  outer_split_num demo_race     n\n            <int> <chr>     <int>\n1               4 not white     2\n2               4 white        28\n3               9 not white     4\n4               9 white        26\n5              23 not white     2\n6              23 white        28\n```\n\n\n:::\n:::\n\n\n\n\nSplits above .5\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfeat_preds |> \n  filter(!(outer_split_num %in% outer_splits)) |> \n  group_by(subid, outer_split_num) |> \n  slice_head(n = 1) |> \n  ungroup() |> \n  count(outer_split_num, demo_race) |> \n  print(n = Inf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 53 × 3\n   outer_split_num demo_race     n\n             <int> <chr>     <int>\n 1               1 not white     4\n 2               1 white        27\n 3               2 not white     7\n 4               2 white        23\n 5               3 not white     5\n 6               3 white        25\n 7               5 not white     2\n 8               5 white        28\n 9               6 not white     5\n10               6 white        26\n11               7 not white     1\n12               7 white        29\n13               8 not white     5\n14               8 white        25\n15              10 not white     5\n16              10 white        25\n17              11 not white     2\n18              11 white        29\n19              12 not white     6\n20              12 white        24\n21              13 not white     1\n22              13 white        29\n23              14 not white     6\n24              14 white        24\n25              15 not white     5\n26              15 white        25\n27              16 not white     5\n28              16 white        26\n29              17 not white     3\n30              17 white        27\n31              18 not white     7\n32              18 white        23\n33              19 not white     5\n34              19 white        25\n35              20 white        30\n36              21 not white     6\n37              21 white        25\n38              22 not white     3\n39              22 white        27\n40              24 not white     5\n41              24 white        25\n42              25 not white     4\n43              25 white        26\n44              26 not white     3\n45              26 white        28\n46              27 not white     2\n47              27 white        28\n48              28 not white     7\n49              28 white        23\n50              29 not white     3\n51              29 white        27\n52              30 not white     5\n53              30 white        25\n```\n\n\n:::\n:::\n\n\n\n\n\nBayseian\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nci_dem\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 6\n  model              pp_median pp_lower pp_upper lag    group                   \n  <fct>                  <dbl>    <dbl>    <dbl> <fct>  <chr>                   \n1 female                 0.890    0.862    0.911 No lag Sex (female, male)      \n2 male                   0.933    0.916    0.946 No lag Sex (female, male)      \n3 above poverty          0.909    0.870    0.936 No lag Income (below poverty, …\n4 below poverty          0.897    0.854    0.928 No lag Income (below poverty, …\n5 non-hispanic white     0.916    0.848    0.955 No lag Race (not White, White) \n6 not white              0.781    0.646    0.873 No lag Race (not White, White) \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden  code-fold=\"true\"}\n#| code-fold: true\n\nrace_no_lag <- pp_tidy_dem |>\n  filter(lag == \"No lag\") |> \n  filter(str_detect(group, \"Race\")) |> \n  mutate(model = factor(model, levels = c(\"not white\", \"non-hispanic white\"))) |> \n  ggplot() + \n  geom_histogram(aes(x = posterior, fill = model), color = \"black\", linewidth = .5,  \n                 bins = 60, fill = \"light grey\") +\n  geom_segment(mapping = aes(y = 3400, yend = 3800, x = pp_median, xend = pp_median),\n               linewidth = .5, color = \"black\", data = ci_dem |> filter(str_detect(group, \"Race\") & lag == \"No lag\") |> \n                 mutate(model = factor(model, levels = c(\"not white\", \"non-hispanic white\"))) ) +\n  geom_segment(mapping = aes(y = 3600, yend = 3600, x = pp_lower, xend = pp_upper),\n               linewidth = .5, color = \"black\", data = ci_dem |> filter(str_detect(group, \"Race\") & lag == \"No lag\")  |> \n                 mutate(model = factor(model, levels = c(\"not white\", \"non-hispanic white\"))) ) +\n  facet_grid(model~group) +\n  geom_vline(xintercept = .5, linewidth = .5, linetype = \"dashed\") +\n  scale_y_continuous(\"Posterior Probability\") +\n  xlab(NULL) +\n  expand_limits(x = c(.5, 1)) +\n  theme_classic() +\n  theme(legend.position = \"none\",\n        text = element_text(size = 15),\n        strip.text.y = element_blank())\n\nincome_no_lag <- pp_tidy_dem |>\n  filter(lag == \"No lag\") |> \n  filter(str_detect(group, \"Income\")) |> \n  mutate(model = factor(model, levels = c(\"below poverty\", \"above poverty\"))) |> \n  ggplot() + \n  geom_histogram(aes(x = posterior, fill = model), color = \"black\", linewidth = .5,  \n                 bins = 60, fill = \"light grey\") +\n  geom_segment(mapping = aes(y = 3400, yend = 3800, x = pp_median, xend = pp_median),\n               linewidth = .5, color = \"black\", data = ci_dem |> filter(str_detect(group, \"Income\") & lag == \"No lag\") |> \n                 mutate(model = factor(model, levels = c(\"below poverty\", \"above poverty\"))) ) +\n  geom_segment(mapping = aes(y = 3600, yend = 3600, x = pp_lower, xend = pp_upper),\n               linewidth = .5, color = \"black\", data = ci_dem |> filter(str_detect(group, \"Income\") & lag == \"No lag\")  |> \n                 mutate(model = factor(model, levels = c(\"below poverty\", \"above poverty\"))) ) +\n  facet_grid(model~group) +\n  geom_vline(xintercept = .5, linewidth = .5, linetype = \"dashed\") +\n  scale_y_continuous(NULL) +\n  xlab(\"Area Under ROC Curve\") +\n  expand_limits(x = c(.5, 1)) +\n  theme_classic() +\n  theme(legend.position = \"none\",\n        text = element_text(size = 15),\n        strip.text.y = element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        axis.line.y = element_blank())\n\nsex_no_lag <- pp_tidy_dem |>\n  filter(lag == \"No lag\") |> \n  filter(str_detect(group, \"Sex\")) |> \n  ggplot() + \n  geom_histogram(aes(x = posterior, fill = model), color = \"black\", linewidth = .5,  \n                 bins = 60, fill = \"light grey\") +\n  geom_segment(mapping = aes(y = 3400, yend = 3800, x = pp_median, xend = pp_median),\n               linewidth = .5, color = \"black\", data = ci_dem |> filter(str_detect(group, \"Sex\") & lag == \"No lag\") ) +\n  geom_segment(mapping = aes(y = 3600, yend = 3600, x = pp_lower, xend = pp_upper),\n               linewidth = .5, color = \"black\", data = ci_dem |> filter(str_detect(group, \"Sex\") & lag == \"No lag\")  ) +\n  facet_grid(model~group) +\n  geom_vline(xintercept = .5, linewidth = .5, linetype = \"dashed\") +\n  scale_y_continuous(NULL) +\n  xlab(NULL) +\n  expand_limits(x = c(.5, 1)) +\n  theme_classic() +\n  theme(legend.position = \"none\",\n        text = element_text(size = 15),\n        strip.text.y = element_blank(),\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        axis.line.y = element_blank())\n\nrace_no_lag + income_no_lag + sex_no_lag\n```\n\n::: {.cell-output-display}\n![](eval_model_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n\n\n### Shaps\n",
    "supporting": [
      "eval_model_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}