{
  "hash": "3ad46a25d9cf2271788cb625a4aba82b",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Supplemental Material\"\nauthor: \"Kendra Wyant, Gaylen E. Fronk, Jiachen Yu, and John J. Curtin\"\ndate: last-modified\nnumber-sections: true\nformat: \n  html: \n    embed-resources: true\n    toc: true \n    toc_depth: 5\nexecute:\n  echo: false\neditor_options: \n  chunk_output_type: console\n---\n\n\n\nThis file contains the supplemental materials for *Forecasting Risk of Alcohol Lapse up to Two Weeks in Advance using Time-lagged Machine Learning Models*. It includes a transparency report and all supplemental figures and tables. Additional materials are made available on our study's OSF page ([https://osf.io/xta67/](https://osf.io/xta67/)).   \n\n-----\n\n## Transparency Report 1.0 (full, 36 items; Aczel et al., 2019)\n\n**Manuscript Title:** Forecasting Risk of Alcohol Lapse up to Two Weeks in Advance using Time-lagged Machine Learning Models   \n**Authors:** Kendra Wyant, Gaylen E. Fronk, Jiachen Yu, and John J. Curtin   \n**Corresponding author’s email address:** jjcurtin@wisc.edu   \n**Link to Project Repository:** [https://osf.io/xta67/](https://osf.io/xta67/)      \n\n### Preregistration Section   \n- Prior to analyzing the complete data set, a time-stamped preregistration was posted in an independent, third-party registry for the data analysis plan: Yes  \n\nComments about your Preregistration: We pre-registered our data analytic strategy on OSF.   \n\n### Methods Section\nThe manuscript fully describes…    \n\n- the rationale for the sample size used (e.g., an a priori power analysis): Yes  \n- how participants were recruited: Yes  \n- how participants were selected (e.g., eligibility criteria): Yes  \n- what compensation was offered for participation: Yes  \n- how participant dropout was handled (e.g., replaced, omitted, etc): Yes  \n- how participants were assigned to conditions: N/A.  There are no conditions.  \n- how stimulus materials were randomized: N/A.    \n- whether (and, if so, how) participants, experimenters, and data-analysts were kept naive to potentially biasing information: N/A.  This is an observations study that does not include analysis of group or manipulations.   There were no study conditions to blind.   \n- the study design, procedures, and materials to allow independent replication: Yes   \n-\tthe measures of interest (e.g., friendliness): Yes   \n-\tall operationalizations for the measures of interest (e.g., a questionnaire measuring friendliness): Yes   \n\n### Results and Discussion Section\nThe manuscript…  \n\n-\tdistinguishes explicitly between “confirmatory” (i.e., prespecified) and “exploratory” (i.e., not prespecified) analyses: All analyses were pre-registered.\n-\tdescribes how violations of statistical assumptions were handled: No  \n-\tjustifies all statistical choices (e.g., including or excluding covariates; applying or not applying transformations; use of multi-level models vs. ANOVA): Yes  \n-\treports the sample size for each cell of the design: Yes  \n-\treports how incomplete or missing data were handled: Yes  \n-\tpresents protocols for data preprocessing (e.g., cleaning, discarding of cases and items, normalizing, smoothing, artifact correction): Yes  \n\n### Data, Code, and Materials Availability Section\nThe following have been made publicly available…  \n\n-\tthe (processed) data, on which the analyses of the manuscript were based: Yes   \n-\tall code and software (that is not copyright protected): Yes   \n-\tall instructions, stimuli, and test materials (that are not copyright protected): Yes   \n-\tAre the data properly archived (i.e., would a graduate student with relevant background knowledge be able to identify each variable and reproduce the analysis): Yes   \n-\tThe manuscript includes a statement concerning the availability and location of all research items, including data, materials, and code relevant to the study: Yes   \n\n\n\\newpage\n\n\n## Supplemental Figures\n\n### Figure S1: Raw Predicted Probabilities\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden  code-fold=\"true\"}\n#| code-fold: true\n\nsuppressPackageStartupMessages(library(tidyverse))\nsuppressPackageStartupMessages(source(\"https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true\"))\nsuppressPackageStartupMessages(library(tidyposterior))\nsuppressPackageStartupMessages(library(kableExtra))\nsuppressWarnings(library(ggrepel))\nlibrary(patchwork)\n\n\ntheme_set(theme_classic())\n\noptions(knitr.kable.NA = '')\n\npath_models_lag <- format_path(str_c(\"risk/models/lag\"))\npath_processed <- format_path(str_c(\"risk/data_processed/lag\"))\n\npp_tidy <- read_csv(here::here(path_models_lag, \"posteriors.csv\"), \n                                 show_col_types = FALSE) \n\nci <- read_csv(here::here(path_models_lag, \"pp_perf_tibble.csv\"), \n                                 show_col_types = FALSE) |> \n  mutate(model = factor(model, levels = c(\"0 lag\", \"24 lag\", \"72 lag\", \"168 lag\", \"336 lag\"),\n                        labels = c(\"No lag\", \"1 day\", \"3 days\", \"1 week\", \"2 weeks\")))\n\npp_dem <- read_csv(here::here(path_models_lag, \"pp_dem_all.csv\"), \n                                 show_col_types = FALSE)\n\npp_dem_contrast <- read_csv(here::here(path_models_lag, \"pp_dem_contrast_all.csv\"), \n                                 show_col_types = FALSE) |> \n  mutate(lag = factor(lag, levels = c(\"0\", \"24\", \"72\", \"168\", \"336\"),\n                        labels = c(\"No lag\", \"1 day\", \"3 days\", \"1 week\", \"2 weeks\")))\n\nlabels <- read_csv(here::here(path_processed, \"labels_1day_0lag.csv\"),\n                   show_col_types = FALSE)\n\ndem_tbl <- read_csv(here::here(path_processed, \"dem_tibble.csv\"),\n                   show_col_types = FALSE)\n\nlabels_dem <- labels |> \n  left_join(dem_tbl, by = \"subid\")\n\n\npreds_0 <- read_rds(here::here(path_models_lag, \n                               \"final_preds_kfold_1_x_5_1day_0_v3_strat_lh_final.rds\")) \npreds_24 <- read_rds(here::here(path_models_lag, \n                               \"final_preds_kfold_1_x_5_1day_24_v3_strat_lh_final.rds\")) \npreds_72 <- read_rds(here::here(path_models_lag, \n                               \"final_preds_kfold_1_x_5_1day_72_v3_strat_lh_final.rds\")) \npreds_168 <- read_rds(here::here(path_models_lag, \n                               \"final_preds_kfold_1_x_5_1day_168_v3_strat_lh_final.rds\")) \npreds_336 <- read_rds(here::here(path_models_lag, \n                               \"final_preds_kfold_1_x_5_1day_336_v3_strat_lh_final.rds\")) \n\npreds_all <- preds_0 |> \n  mutate(model = \"No lag\") |> \n  bind_rows(preds_24 |> \n              mutate(model = \"1 day\")) |> \n  bind_rows(preds_72 |> \n              mutate(model = \"3 days\")) |> \n  bind_rows(preds_168 |> \n              mutate(model = \"1 week\")) |> \n  bind_rows(preds_336 |> \n              mutate(model = \"2 weeks\")) |> \n  mutate(model = factor(model, levels = c(\"No lag\", \"1 day\", \"3 days\", \"1 week\", \"2 weeks\")))\n\npreds_hist <- preds_all |> \n  ggplot(aes(x = prob_raw)) +\n  geom_histogram(color = \"black\", fill = \"light grey\", binwidth = .10,\n                 boundary = 0) +\n  facet_wrap(~model) +\n  labs(x = \"Raw probabilities from final model\") +\n  scale_x_continuous(breaks = seq(0, 1, by = 0.2))\n```\n:::\n\n\n\nOur models produced variation in predicted probabilities, with probabilities spanning nearly the entire 0 - 1 range. The 2-week lagged model had fewer high raw probabilities (all probabilities were < .80).  Histograms of the raw predicted probabilities for the best configuration for all 5 models are presented below. \n\n\n\n::: {#cell-fig-s1 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-s1\n#| fig-cap: \"Histograms of raw probabilities of our best model configurations for each classification model (no lag, 1-day, 3-day, 1-week and 2-week lags).\"\n#| fig-width: 8\n#| fig-height: 5\n\npreds_hist\n```\n\n::: {.cell-output-display}\n![Histograms of raw probabilities of our best model configurations for each classification model (no lag, 1-day, 3-day, 1-week and 2-week lags).](supplement_files/figure-html/fig-s1-1.png){#fig-s1 width=768}\n:::\n:::\n\n\n\n### Figure S2: Calibration Plots for all Models\n\nThe raw probabilities produced by our final models were not well calibrated. Brier scores for the no lag model (.071) and the 2-week lag model (.077) were roughly equivalent to the base rate of lapses (.076). Below we present the calibration plots of our raw predicted lapse probabilities for each model.\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden  code-fold=\"true\"}\n#| code-fold: true\n\nbin_width = 0.10\n\npreds_all_raw <- preds_0 |> \n  mutate(bins = cut(prob_raw, breaks = seq(0, 1, bin_width)), \n         lapse = if_else(label == \"Lapse\", 1, 0)) |> \n  mutate(model = \"No lag\") |> \n  bind_rows(preds_24 |> \n              mutate(bins = cut(prob_raw, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"1 day\")) |> \n  bind_rows(preds_72 |> \n              mutate(bins = cut(prob_raw, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"3 days\")) |> \n  bind_rows(preds_168 |> \n              mutate(bins = cut(prob_raw, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"1 week\")) |> \n  bind_rows(preds_336 |> \n              mutate(bins = cut(prob_raw, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"2 weeks\")) |> \n  mutate(model = factor(model, levels = c(\"No lag\", \"1 day\", \"3 days\", \"1 week\", \"2 weeks\")),\n         prob = \"Raw (uncalibrated)\")\n\npreds_all_beta <- preds_0 |> \n  mutate(bins = cut(prob_beta, breaks = seq(0, 1, bin_width)), \n         lapse = if_else(label == \"Lapse\", 1, 0)) |> \n  mutate(model = \"No lag\") |> \n  bind_rows(preds_24 |> \n              mutate(bins = cut(prob_beta, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"1 day\")) |> \n  bind_rows(preds_72 |> \n              mutate(bins = cut(prob_beta, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"3 days\")) |> \n  bind_rows(preds_168 |> \n              mutate(bins = cut(prob_beta, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"1 week\")) |> \n  bind_rows(preds_336 |> \n              mutate(bins = cut(prob_beta, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"2 weeks\")) |> \n  mutate(model = factor(model, levels = c(\"No lag\", \"1 day\", \"3 days\", \"1 week\", \"2 weeks\")),\n         prob = \"Beta calibration\")\n\npreds_all_logi <- preds_0 |> \n  mutate(bins = cut(prob_logi, breaks = seq(0, 1, bin_width)), \n         lapse = if_else(label == \"Lapse\", 1, 0)) |> \n  mutate(model = \"No lag\") |> \n  bind_rows(preds_24 |> \n              mutate(bins = cut(prob_logi, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"1 day\")) |> \n  bind_rows(preds_72 |> \n              mutate(bins = cut(prob_logi, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"3 days\")) |> \n  bind_rows(preds_168 |> \n              mutate(bins = cut(prob_logi, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"1 week\")) |> \n  bind_rows(preds_336 |> \n              mutate(bins = cut(prob_logi, breaks = seq(0, 1, bin_width)), \n                     lapse = if_else(label == \"Lapse\", 1, 0)) |> \n              mutate(model = \"2 weeks\")) |> \n  mutate(model = factor(model, levels = c(\"No lag\", \"1 day\", \"3 days\", \"1 week\", \"2 weeks\")),\n         prob = \"Logistic calibration\")\n\npreds_all <- preds_all_raw |> \n  bind_rows(preds_all_beta) |> \n  bind_rows(preds_all_logi) \n\nmini_hist <- preds_all_raw |>\n  count(bins, model) |> \n  bind_rows(tibble(bins = \"(0.9,1]\",\n                   model = \"2 weeks\",\n                   n = 0)) |> \n  group_by(model) |> \n  mutate(\n    bins = seq(1, 10, 1),\n    x = bin_width / 2 + bin_width * (bins - 1),       \n    y = n / max(n) * 0.07\n  ) |> \n  mutate(model = factor(model, levels = c(\"No lag\", \"1 day\", \"3 days\",\n                                          \"1 week\", \"2 weeks\"))) \n\n\nplot_cal <- preds_all |> \n  mutate(prob = factor(prob, levels = c(\"Raw (uncalibrated)\", \n                                        \"Beta calibration\", \n                                        \"Logistic calibration\"))) |> \n  group_by(bins, model, prob)  |> \n  summarize(mean_lapse = mean(lapse), .groups = \"drop\") |> \n  mutate(\n    bins = as.numeric(bins),\n    midpoints = bin_width/2 + bin_width * (bins - 1)\n  )  |> \n  ggplot(aes(x = midpoints, y = mean_lapse, group = prob,\n             color = prob, linetype = prob)) +\n  geom_abline(slope = 1, intercept = 0, linetype = \"longdash\", color = \"gray80\") +\n  geom_line(linewidth = .7) +\n  geom_rect(data = mini_hist, inherit.aes = FALSE,\n            aes(xmin = x - bin_width / 2,\n                xmax = x + bin_width / 2,\n                ymin = -y,\n                ymax = 0),\n            alpha = .4) +\n  facet_wrap(~ model, ncol = 2) +\n  labs(\n    x = \"Predicted Lapse Probability (Bin Midpoint)\",\n    y = \"Observed Lapse Probability\",\n    color = NULL,\n    linetype = NULL\n  ) +\n  scale_x_continuous(breaks = seq(0, 1, bin_width), limits = c(0, 1)) +\n  scale_y_continuous(limits = c(-0.08, 1), breaks = seq(0,1, bin_width),\n                     expand = c(0, 0)) +\n  coord_cartesian(clip = \"off\") +\n  scale_color_manual(values = c(\"black\", \"#458892\", \"#cb6bce\")) +\n  scale_linetype_manual(values = c(\"solid\", \"twodash\", \"dotted\")) +\n  theme_classic(base_size = 11) +\n  theme(\n    legend.position = \"bottom\",\n    strip.text = element_text(face = \"bold\", size = 11),\n    legend.title = element_text(face = \"bold\"),\n    legend.text = element_text(size = 10),\n    axis.text = element_text(size = 10),\n    axis.title = element_text(face = \"bold\")\n  )\n```\n:::\n\n::: {#cell-fig-s2 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-s2\n#| fig-cap: \"Calibration plots of raw and calibrated predicted lapse probabilities (beta, isotonic, and logistic) across models (no lag, 1-day, 3-day, 1-week, and 2-week lag). Predicted probabilities (x-axis) are binned into deciles. Observed lapse probability (y-axis) represents the proportion of actual lapses observed in each bin. The dashed diagonal represents perfect calibration. Points below the line indicate overestimation and points above the line indicate underestimation. Raw probabilities are depicted as solid black curve. Beta and logistic calibrated probabilites are depicted as green dashed curve and pink dotted curve, respectively. The grey histogram along the bottom of the plot represents the proportion of raw probabilities in each bin.\"\n#| fig-width: 8\n#| fig-height: 10\n\nplot_cal\n```\n\n::: {.cell-output-display}\n![Calibration plots of raw and calibrated predicted lapse probabilities (beta, isotonic, and logistic) across models (no lag, 1-day, 3-day, 1-week, and 2-week lag). Predicted probabilities (x-axis) are binned into deciles. Observed lapse probability (y-axis) represents the proportion of actual lapses observed in each bin. The dashed diagonal represents perfect calibration. Points below the line indicate overestimation and points above the line indicate underestimation. Raw probabilities are depicted as solid black curve. Beta and logistic calibrated probabilites are depicted as green dashed curve and pink dotted curve, respectively. The grey histogram along the bottom of the plot represents the proportion of raw probabilities in each bin.](supplement_files/figure-html/fig-s2-1.png){#fig-s2 width=768}\n:::\n:::\n\n\n\n\n### Figure S3: Global Shapley Plots for all 5 Models\n\nThe top globally important feature category (i.e., highest mean |Shapley value|) for all models was past use. Future efficacy was a strong predictor for more immediate model predictions (i.e., no lag and 1-day lag), but as lag time increased importance attenuated. On the other hand, as lag time increased past/future risky situations increased in importance. Craving was consistently important, in magnitude, across all models.\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden  code-fold=\"true\"}\n#| code-fold: true\n\nshap_grp_0 <- read_rds(here::here(path_models_lag, \n                      \"final_shapsgrp_kfold_1_x_5_1day_0_v3_strat_lh_final.rds\")) |> \n   filter(str_detect(variable_grp, \"EMA\")) |> \n   mutate(variable_grp = str_remove(variable_grp, \"\\\\(EMA item\\\\)\")) \n\n\nshap_grp_24 <- read_rds(here::here(path_models_lag, \n                      \"final_shapsgrp_kfold_1_x_5_1day_24_v3_strat_lh_final.rds\")) |> \n   filter(str_detect(variable_grp, \"EMA\")) |> \n   mutate(variable_grp = str_remove(variable_grp, \"\\\\(EMA item\\\\)\")) \n\n\nshap_grp_72 <- read_rds(here::here(path_models_lag, \n                      \"final_shapsgrp_kfold_1_x_5_1day_72_v3_strat_lh_final.rds\")) |> \n   filter(str_detect(variable_grp, \"EMA\")) |> \n   mutate(variable_grp = str_remove(variable_grp, \"\\\\(EMA item\\\\)\")) \n\n\nshap_grp_168 <- read_rds(here::here(path_models_lag, \n                      \"final_shapsgrp_kfold_1_x_5_1day_168_v3_strat_lh_final.rds\")) |> \n   filter(str_detect(variable_grp, \"EMA\")) |> \n   mutate(variable_grp = str_remove(variable_grp, \"\\\\(EMA item\\\\)\")) \n\nshap_grp_336 <- read_rds(here::here(path_models_lag, \n                      \"final_shapsgrp_kfold_1_x_5_1day_336_v3_strat_lh_final.rds\")) |> \n   filter(str_detect(variable_grp, \"EMA\")) |> \n  mutate(variable_grp = str_remove(variable_grp, \"\\\\(EMA item\\\\)\"))  \n\n# shap_global <- shap_grp_0 |> \n#   mutate(model = \"No lag\") |> \n#   bind_rows(shap_grp_24 |> \n#               mutate(model = \"1 day\")) |>\n#   bind_rows(shap_grp_72 |> \n#               mutate(model = \"3 days\")) |>\n#   bind_rows(shap_grp_168 |> \n#               mutate(model = \"1 week\")) |>\n#   bind_rows(shap_grp_336 |> \n#               mutate(model = \"2 weeks\")) |> \n#   mutate(model = factor(model, levels = c(\"No lag\", \"1 day\", \"3 days\",\n#                                           \"1 week\", \"2 weeks\"))) |> \n#   group_by(variable_grp, model) |> \n#   summarize(mean_value = mean(abs(value)), .groups = \"drop\")\n\nshap_global <- shap_grp_0 |>\n  mutate(model = 0) |>\n  bind_rows(shap_grp_24 |>\n              mutate(model = 24)) |>\n  bind_rows(shap_grp_72 |>\n              mutate(model = 72)) |>\n  bind_rows(shap_grp_168 |>\n              mutate(model = 168)) |>\n  bind_rows(shap_grp_336 |>\n              mutate(model = 336)) |>\n  group_by(variable_grp, model) |>\n  summarize(mean_value = mean(abs(value)), .groups = \"drop\") |> \n  mutate(variable_grp = str_remove(variable_grp, \"past/future \"),\n         variable_grp = if_else(variable_grp == \"past pleasant event \",\n                                \"pleasant event\", variable_grp))\n\nshap_levels <- shap_global |>\n  mutate(variable_grp = reorder(variable_grp, mean_value, sum)) |>\n  pull(variable_grp) |>\n  levels()\n\n# fig_s3 <- shap_global |>\n#   mutate(variable_grp = factor(variable_grp, levels = shap_levels)) |> \n#   ggplot() +\n#   geom_bar(aes(x = variable_grp, y = mean_value), \n#            stat = \"identity\", position = \"dodge\",\n#            color = \"black\", fill = \"light grey\") +\n#   labs(y = \"Mean(|Shapley Value|)\",\n#        x = NULL,\n#        fill = NULL) +\n#   facet_wrap(~model, nrow = 1) +\n#   theme(axis.text=element_text(size=9.5),\n#         legend.key.size = unit(0.25, \"cm\"),\n#         panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1),\n#         legend.position = \"right\") +\n#   coord_flip()\n\nlabel_data <- shap_global |>\n  filter(model == 336)\n\nfig_s3 <- shap_global |>\n  mutate(variable_grp = factor(variable_grp, levels = shap_levels)) |> \n  ggplot() +\n  geom_line(aes(x = model, y = mean_value, color = variable_grp)) +\n  labs(y = \"Mean(|Shapley Value|)\",\n       x = NULL,\n       fill = NULL) +\n  geom_text_repel(\n    data = label_data,\n    aes(x = model, y = mean_value, color = variable_grp, label = variable_grp),\n    fontface = \"bold\",\n    size = 4,\n    direction = \"y\",\n    hjust = 0,\n    nudge_x = 5,\n    segment.size = .7,\n    segment.alpha = .5,\n    segment.linetype = \"dotted\",\n    box.padding = 0,\n    segment.curvature = -0.1,\n    segment.ncp = 3,\n    segment.angle = 20\n  ) +\n  scale_x_continuous(breaks = c(0, 24, 72, 168, 336),\n                     labels = c(\"No lag\", \"1 day\", \"3 days\", \"1 week\", \"2 weeks\"),\n                     limits = c(0, 425)) +\n  theme(axis.text=element_text(size=9.5),\n        legend.key.size = unit(0.25, \"cm\"),\n        legend.position = \"none\")\n```\n:::\n\n::: {#cell-fig-s3 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-s3\n#| fig-cap: \"Global importance (mean |Shapley value|) for feature categories shown separately by model. Feature categories are ordered by their aggregate global importance.\"\n#| fig-width: 8\n#| fig-height: 5\n\nfig_s3\n```\n\n::: {.cell-output-display}\n![Global importance (mean |Shapley value|) for feature categories shown separately by model. Feature categories are ordered by their aggregate global importance.](supplement_files/figure-html/fig-s3-1.png){#fig-s3 width=768}\n:::\n:::\n\n\n\n\n\n### Figure S4: Global Shapley Plots for Baseline and 2-Week Lag Model by Demographic Group\n\nWe saw similar patterns in global feature importance across different demographic subgroups (race/ethnicity, income, sex at birth). Plots of global feature importance by demographic subgroup for the no lag and 2-week lag models are presented below. \n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden  code-fold=\"true\"}\n#| code-fold: true\n\nfeat_0 <- read_csv(here::here(path_processed, \n                            \"features_0lag_v3.csv\"),\n                 col_types = cols()) |> \n  select(label_num, subid, dttm_label, lapse, demo_age, demo_sex, \n         demo_income, demo_race) |> \n  arrange(label_num) \n\n\nfeat_shaps_0 <- feat_0 |> \n  rename(id_obs = label_num) |>\n  right_join(shap_grp_0, by = c(\"id_obs\")) \n\nbaseline_sex <- feat_shaps_0 |> \n  mutate(group = if_else(demo_sex == \"Male\", \n                         \"advantaged group (non-Hispanic White, male, above poverty)\",\n                         \"disadvantaged group (not White, female, below poverty)\",\n                         ),\n         group = factor(group, levels = c(\"disadvantaged group (not White, female, below poverty)\",\n                                          \"advantaged group (non-Hispanic White, male, above poverty)\")),\n         model = \"No Lag\") |> \n  group_by(model, group, variable_grp) |> \n  summarize(mean_value = mean(abs(value)), .groups = \"drop\") |> \n  arrange(mean_value) |> \n  mutate(variable_grp = factor(variable_grp),\n         variable_grp = fct_inorder(variable_grp)) |> \n  ggplot() +\n  geom_bar(aes(x = variable_grp, y = mean_value, group = group, \n                 fill = group),  \n             stat = \"identity\", position = \"dodge\") +\n  facet_wrap(~model, strip.position = \"left\") +\n  labs(title = \"Sex at Birth\",\n       y = NULL,\n       x = NULL,\n       color = NULL) +\n  theme(axis.text=element_text(size=9.5),\n        legend.position = \"none\",\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1),\n        strip.placement = \"outside\") +\n  scale_fill_manual(values = c(\"#cb6bce\", \"#240e31\")) +\n  coord_flip()\n\nbaseline_race <- feat_shaps_0 |> \n  mutate(group = if_else(demo_race == \"White/Caucasian\", \n                         \"advantaged group (non-Hispanic White, male, above poverty)\",\n                         \"disadvantaged group (not White, female, below poverty)\",\n                         ),\n         group = factor(group, levels = c(\"disadvantaged group (not White, female, below poverty)\",\n                                          \"advantaged group (non-Hispanic White, male, above poverty)\"))) |> \n  group_by(group, variable_grp) |> \n  summarize(mean_value = mean(abs(value)), .groups = \"drop\") |> \n  arrange(mean_value) |> \n  mutate(variable_grp = factor(variable_grp),\n         variable_grp = fct_inorder(variable_grp)) |> \n  ggplot() +\n  geom_bar(aes(x = variable_grp, y = mean_value, group = group, \n                 fill = group),  \n             stat = \"identity\", position = \"dodge\") +\n  labs(title = \"Race/Ethnicity\",\n       y = \"Mean(|Shapley Value|)\",\n       x = NULL,\n       color = NULL) +\n  theme(axis.text=element_text(size=9.5),\n        axis.text.y = element_blank(),\n        legend.position = \"none\",\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1)) +\n  scale_fill_manual(values = c(\"#cb6bce\", \"#240e31\")) +\n  coord_flip()\n\n\nbaseline_income <- feat_shaps_0 |> \n  mutate(group = if_else(demo_income >= 1560, \n                         \"advantaged group (non-Hispanic White, male, above poverty)\",\n                         \"disadvantaged group (not White, female, below poverty)\",\n                         ),\n         group = factor(group, levels = c(\"disadvantaged group (not White, female, below poverty)\",\n                                          \"advantaged group (non-Hispanic White, male, above poverty)\"))) |> \n  group_by(group, variable_grp) |> \n  summarize(mean_value = mean(abs(value)), .groups = \"drop\") |> \n  arrange(mean_value) |> \n  mutate(variable_grp = factor(variable_grp),\n         variable_grp = fct_inorder(variable_grp)) |> \n  ggplot() +\n  geom_bar(aes(x = variable_grp, y = mean_value, group = group, \n                 fill = group),  \n             stat = \"identity\", position = \"dodge\") +\n  labs(title = \"Income\",\n       y = NULL,\n       x = NULL,\n       color = NULL) +\n  theme(axis.text=element_text(size=9.5),\n        axis.text.y = element_blank(),\n        legend.position = \"none\",\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1)) +\n  scale_fill_manual(values = c(\"#cb6bce\", \"#240e31\")) +\n  coord_flip()\n\n\nno_lag <- baseline_sex + baseline_race + baseline_income \n\n\nfeat_336 <- read_csv(here::here(path_processed, \n                            \"features_336lag_v3.csv\"),\n                 col_types = cols()) |> \n  select(label_num, subid, dttm_label, lapse, demo_age, demo_sex, \n         demo_income, demo_race) |> \n  arrange(label_num) \n\n\nfeat_shaps_336 <- feat_336 |> \n  rename(id_obs = label_num) |>\n  right_join(shap_grp_336, by = c(\"id_obs\")) \n\ntwoweek_sex <- feat_shaps_336 |> \n  mutate(group = if_else(demo_sex == \"Male\", \n                         \"advantaged group (non-Hispanic White, male, above poverty)\",\n                         \"disadvantaged group (not White, female, below poverty)\",\n                         ),\n         group = factor(group, levels = c(\"disadvantaged group (not White, female, below poverty)\",\n                                          \"advantaged group (non-Hispanic White, male, above poverty)\")),\n         model = \"2-Week Lag\") |> \n  group_by(model, group, variable_grp) |> \n  summarize(mean_value = mean(abs(value)), .groups = \"drop\") |> \n  arrange(mean_value) |> \n  mutate(variable_grp = factor(variable_grp),\n         variable_grp = fct_inorder(variable_grp)) |> \n  ggplot() +\n  geom_bar(aes(x = variable_grp, y = mean_value, group = group, \n                 fill = group),  \n             stat = \"identity\", position = \"dodge\") +\n  facet_wrap(~model, strip.position = \"left\") +\n  labs(title = \"Sex at Birth\",\n       y = NULL,\n       x = NULL,\n       color = NULL) +\n  theme(axis.text=element_text(size=9.5),\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1),\n        strip.placement = \"outside\") +\n  scale_fill_manual(values = c(\"#cb6bce\", \"#240e31\")) +\n  coord_flip()\n\ntwoweek_race <- feat_shaps_336 |> \n  mutate(group = if_else(demo_race == \"White/Caucasian\", \n                         \"advantaged group (non-Hispanic White, male, above poverty)\",\n                         \"disadvantaged group (not White, female, below poverty)\",\n                         ),\n         group = factor(group, levels = c(\"disadvantaged group (not White, female, below poverty)\",\n                                          \"advantaged group (non-Hispanic White, male, above poverty)\"))) |> \n  group_by(group, variable_grp) |> \n  summarize(mean_value = mean(abs(value)), .groups = \"drop\") |> \n  arrange(mean_value) |> \n  mutate(variable_grp = factor(variable_grp),\n         variable_grp = fct_inorder(variable_grp)) |> \n  ggplot() +\n  geom_bar(aes(x = variable_grp, y = mean_value, group = group, \n                 fill = group),  \n             stat = \"identity\", position = \"dodge\") +\n  labs(title = \"Race/Ethnicity\",\n       y = \"Mean(|Shapley Value|)\",\n       x = NULL,\n       color = NULL) +\n  theme(axis.text=element_text(size=9.5),\n        axis.text.y = element_blank(),\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1)) +\n  scale_fill_manual(values = c(\"#cb6bce\", \"#240e31\")) +\n  coord_flip()\n\ntwoweek_income <- feat_shaps_336 |> \n  mutate(group = if_else(demo_income >= 1560, \n                         \"advantaged group (non-Hispanic White, male, above poverty)\",\n                         \"disadvantaged group (not White, female, below poverty)\",\n                         ),\n         group = factor(group, levels = c(\"disadvantaged group (not White, female, below poverty)\",\n                                          \"advantaged group (non-Hispanic White, male, above poverty)\"))) |> \n  group_by(group, variable_grp) |> \n  summarize(mean_value = mean(abs(value)), .groups = \"drop\") |> \n  arrange(mean_value) |> \n  mutate(variable_grp = factor(variable_grp),\n         variable_grp = fct_inorder(variable_grp)) |> \n  ggplot() +\n  geom_bar(aes(x = variable_grp, y = mean_value, group = group, \n                 fill = group),  \n             stat = \"identity\", position = \"dodge\") +\n  labs(title = \"Income\",\n       y = NULL,\n       x = NULL,\n       color = NULL) +\n  theme(axis.text=element_text(size=9.5),\n        axis.text.y = element_blank(),\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1)) +\n  scale_fill_manual(values = c(\"#cb6bce\", \"#240e31\")) +\n  coord_flip()\n\ntwoweek_lag <- twoweek_sex + twoweek_race + twoweek_income  + \n  plot_layout(guides = \"collect\") &\n  theme(legend.position = \"bottom\", legend.direction = \"vertical\") \n\nfig_s4 <- no_lag/twoweek_lag \n```\n:::\n\n::: {#cell-fig-s4 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-s4\n#| fig-cap: \"Global importance (mean |Shapley value|) for feature categories for no lag and two week lag model by demographic group. The importance of each feature category for advantaged and disadvantaged demographic groups are displayed separately by color.\"\n#| fig-height: 6\n#| fig-width: 7\nfig_s4\n```\n\n::: {.cell-output-display}\n![Global importance (mean |Shapley value|) for feature categories for no lag and two week lag model by demographic group. The importance of each feature category for advantaged and disadvantaged demographic groups are displayed separately by color.](supplement_files/figure-html/fig-s4-1.png){#fig-s4 width=672}\n:::\n:::\n\n\n\n\n## Supplemental Tables\n\n### Table S1: Demographic Contrasts for all Models\n\n\n\n::: {#tbl-fairness .cell tbl-cap='This table reports the bayesian model contrasts for each demographic group comparison separately by model and contrast. The median value represents the difference in median area under the ROC curve (auROC) between the two groups. A negative value indicates lower auROC performance for the disadvantaged group (female, not White, income below poverty) compared to the advantaged group (male, White, income above poverty).'}\n\n```{.r .cell-code .hidden  code-fold=\"true\"}\n#| label: tbl-fairness\n#| tbl-cap: \"This table reports the bayesian model contrasts for each demographic group comparison separately by model and contrast. The median value represents the difference in median area under the ROC curve (auROC) between the two groups. A negative value indicates lower auROC performance for the disadvantaged group (female, not White, income below poverty) compared to the advantaged group (male, White, income above poverty).\"\n#| code-fold: true\n\npp_sex <- pp_dem_contrast |> \n  filter(contrast == \"male vs female\") |> \n   mutate(ci = str_c(\"[\", round(lower, 3), \", \", round(upper, 3), \"]\"),\n         median = as.character(round(median, 3)),\n         probability = as.character(round(probability, 3))) |> \n  select(lag, median, ci, probability) |> \n  rename(`Lag`= lag,\n         Median = median,\n         `Bayesian CI` = ci,\n         Probability = probability)\n\npp_income <- pp_dem_contrast |> \n  filter(contrast == \"above poverty vs below poverty\") |> \n   mutate(ci = str_c(\"[\", round(lower, 3), \", \", round(upper, 3), \"]\"),\n         median = as.character(round(median, 3)),\n         probability = as.character(round(probability, 3))) |> \n  select(lag, median, ci, probability) |> \n  rename(`Lag`= lag,\n         `Median ` = median,\n         `Bayesian CI ` = ci,\n         `Probability ` = probability)\n\npp_race <- pp_dem_contrast |> \n  filter(contrast == \"non-hispanic white vs not white\") |> \n   mutate(ci = str_c(\"[\", round(lower, 3), \", \", round(upper, 3), \"]\"),\n         median = as.character(round(median, 3)),\n         probability = as.character(round(probability, 3))) |> \n  select(lag, median, ci, probability) |> \n  rename(`Lag`= lag,\n         `Median  ` = median,\n         `Bayesian CI  ` = ci,\n         `Probability   ` = probability)\n\npp_sex |> \n  full_join(pp_income, by = \"Lag\") |> \n  full_join(pp_race, by = \"Lag\") |> \n  kbl() |> \n  add_header_above(c(\" \" = 1, \"Sex at birth\" = 3, \"Income\" = 3, \"Race/Ethnicity\" = 3))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table>\n <thead>\n<tr>\n<th style=\"empty-cells: hide;border-bottom:hidden;\" colspan=\"1\"></th>\n<th style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"3\"><div style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \">Sex at birth</div></th>\n<th style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"3\"><div style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \">Income</div></th>\n<th style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"3\"><div style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \">Race/Ethnicity</div></th>\n</tr>\n  <tr>\n   <th style=\"text-align:left;\"> Lag </th>\n   <th style=\"text-align:left;\"> Median </th>\n   <th style=\"text-align:left;\"> Bayesian CI </th>\n   <th style=\"text-align:left;\"> Probability </th>\n   <th style=\"text-align:left;\"> Median  </th>\n   <th style=\"text-align:left;\"> Bayesian CI  </th>\n   <th style=\"text-align:left;\"> Probability  </th>\n   <th style=\"text-align:left;\"> Median   </th>\n   <th style=\"text-align:left;\"> Bayesian CI   </th>\n   <th style=\"text-align:left;\"> Probability    </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> No lag </td>\n   <td style=\"text-align:left;\"> 0.043 </td>\n   <td style=\"text-align:left;\"> [0.028, 0.059] </td>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:left;\"> 0.012 </td>\n   <td style=\"text-align:left;\"> [-0.007, 0.033] </td>\n   <td style=\"text-align:left;\"> 0.848 </td>\n   <td style=\"text-align:left;\"> 0.131 </td>\n   <td style=\"text-align:left;\"> [0.057, 0.222] </td>\n   <td style=\"text-align:left;\"> 0.999 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1 day </td>\n   <td style=\"text-align:left;\"> 0.044 </td>\n   <td style=\"text-align:left;\"> [0.027, 0.063] </td>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:left;\"> 0.02 </td>\n   <td style=\"text-align:left;\"> [0.001, 0.04] </td>\n   <td style=\"text-align:left;\"> 0.955 </td>\n   <td style=\"text-align:left;\"> 0.165 </td>\n   <td style=\"text-align:left;\"> [0.072, 0.28] </td>\n   <td style=\"text-align:left;\"> 0.999 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3 days </td>\n   <td style=\"text-align:left;\"> 0.051 </td>\n   <td style=\"text-align:left;\"> [0.031, 0.072] </td>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:left;\"> 0.023 </td>\n   <td style=\"text-align:left;\"> [0.002, 0.045] </td>\n   <td style=\"text-align:left;\"> 0.961 </td>\n   <td style=\"text-align:left;\"> 0.157 </td>\n   <td style=\"text-align:left;\"> [0.087, 0.236] </td>\n   <td style=\"text-align:left;\"> 1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1 week </td>\n   <td style=\"text-align:left;\"> 0.08 </td>\n   <td style=\"text-align:left;\"> [0.059, 0.103] </td>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:left;\"> 0.012 </td>\n   <td style=\"text-align:left;\"> [-0.012, 0.037] </td>\n   <td style=\"text-align:left;\"> 0.807 </td>\n   <td style=\"text-align:left;\"> 0.125 </td>\n   <td style=\"text-align:left;\"> [0.057, 0.204] </td>\n   <td style=\"text-align:left;\"> 0.999 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2 weeks </td>\n   <td style=\"text-align:left;\"> 0.098 </td>\n   <td style=\"text-align:left;\"> [0.073, 0.125] </td>\n   <td style=\"text-align:left;\"> 1 </td>\n   <td style=\"text-align:left;\"> 0.039 </td>\n   <td style=\"text-align:left;\"> [0.008, 0.073] </td>\n   <td style=\"text-align:left;\"> 0.98 </td>\n   <td style=\"text-align:left;\"> 0.13 </td>\n   <td style=\"text-align:left;\"> [0.058, 0.208] </td>\n   <td style=\"text-align:left;\"> 0.998 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n\n\n### Table S2: Brier scores for all models\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbrier <- read_csv(here::here(path_models_lag, \"brier_scores.csv\"))\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nRows: 5 Columns: 4\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (1): model\ndbl (3): raw, logi, beta\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nbrier |> \n  rename(Model = model, \n         `Raw (uncalibrated)` = raw,\n         `Logistic calibration` = logi,\n         `Beta calibration` = beta) |> \n  knitr::kable(digits = 2) |> \n  kableExtra::kable_classic()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\" lightable-classic\" style='font-family: \"Arial Narrow\", \"Source Sans Pro\", sans-serif; margin-left: auto; margin-right: auto;'>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Model </th>\n   <th style=\"text-align:right;\"> Raw (uncalibrated) </th>\n   <th style=\"text-align:right;\"> Logistic calibration </th>\n   <th style=\"text-align:right;\"> Beta calibration </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> No lag </td>\n   <td style=\"text-align:right;\"> 0.07 </td>\n   <td style=\"text-align:right;\"> 0.04 </td>\n   <td style=\"text-align:right;\"> 0.04 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1 day </td>\n   <td style=\"text-align:right;\"> 0.07 </td>\n   <td style=\"text-align:right;\"> 0.05 </td>\n   <td style=\"text-align:right;\"> 0.05 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 3 days </td>\n   <td style=\"text-align:right;\"> 0.13 </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n   <td style=\"text-align:right;\"> 0.05 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 1 week </td>\n   <td style=\"text-align:right;\"> 0.07 </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> 2 weeks </td>\n   <td style=\"text-align:right;\"> 0.08 </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n   <td style=\"text-align:right;\"> 0.06 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n",
    "supporting": [
      "supplement_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}