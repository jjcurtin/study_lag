{
  "hash": "9a80729619a8909a94c6df5333cf6c8d",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Make All Figures for Main Manuscript\"\nauthor: \"Kendra Wyant\"\ndate: \"2025-02-06\"\nnumber-sections: true\noutput: \n  html_document:\n    toc: true \n    toc_depth: 4\nformat:\n  html:\n    embed-resources: true\n    toc: true\n    toc-depth: 4\neditor_options: \n  chunk_output_type: console\nexecute:\n  echo: false\nhtml-table-processing: none\n---\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n#| message: false\n#| warning: false\n\nsuppressPackageStartupMessages(library(tidyverse))\nsuppressPackageStartupMessages(source(\"https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true\"))\nsuppressPackageStartupMessages(library(tidyposterior))\nlibrary(kableExtra, exclude = \"group_rows\")\nlibrary(patchwork)\n\ntheme_set(theme_classic())\n\npath_models_lag <- format_path(str_c(\"studydata/risk/models/lag\"))\npath_shared <- format_path(\"studydata/risk/data_processed/shared\")\npath_processed <- format_path(\"studydata/risk/data_processed/lag\")\n```\n:::\n\n\n\nData for figures\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ntest_metrics_all_pp_perf <- read_csv(here::here(path_models_lag,\n                                                \"pp_perf_tibble.csv\"),\n                                     show_col_types = FALSE)\n\npp_dem <- read_csv(here::here(path_models_lag, \"pp_dem_all.csv\"),\n                            show_col_types = FALSE)\n\nglobal_all <- read_rds(here::here(path_models_lag, \"shap_global_all.rds\")) |> \n   filter(str_detect(variable_grp, \"EMA\")) |> \n   mutate(variable_grp = str_remove(variable_grp, \"\\\\(EMA item\\\\)\"),\n          variable_grp = reorder(variable_grp, mean_value, sum),\n          model = factor(model, levels = c(\"336 lag\", \"168 lag\", \"72 lag\", \"24 lag\", \"0 lag\"),\n                         labels = c(\"2 weeks\", \"1 week\", \"3 days\", \"1 day\", \"No lag\" ))) |> \n  filter(model %in% c(\"2 weeks\", \"No lag\"))\n\nshap_levels <- global_all |>\n  mutate(variable_grp = reorder(variable_grp, mean_value, sum)) |>\n  pull(variable_grp) |>\n  levels()\n```\n:::\n\n\n\n\n## Figure 1: Prediction Methods\n\n\n::: {#cell-fig-method .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-method\n#| fig-cap: \"Panel A shows the prediction timepoints at which our model calculated a predicted probability of a lapse. All available data up until, but not including, the prediction timepoint was used to generate these predictions. Features were created for varying feature scoring epochs before the prediction timepoint (i.e., 12, 24, 48, 72, and 168 hours). Prediction timepoints were updated hourly. Panel B shows how the prediction window (i.e., window in which a lapse might occur) rolls forward hour-by-hour with the prediction timepoint. The prediction window width for all models was 24 hours. Additionally, there were five possible lag times between the prediction timepoint and start of the prediction window. A prediction window either started immediately after the prediction timepoint (no lag) or was lagged by 1 day, 3 days, 1 week, or 2 weeks.\"\n\nknitr::include_graphics(path = here::here(\"figures/methods.png\"), error = FALSE)\n```\n\n::: {.cell-output-display}\n![Panel A shows the prediction timepoints at which our model calculated a predicted probability of a lapse. All available data up until, but not including, the prediction timepoint was used to generate these predictions. Features were created for varying feature scoring epochs before the prediction timepoint (i.e., 12, 24, 48, 72, and 168 hours). Prediction timepoints were updated hourly. Panel B shows how the prediction window (i.e., window in which a lapse might occur) rolls forward hour-by-hour with the prediction timepoint. The prediction window width for all models was 24 hours. Additionally, there were five possible lag times between the prediction timepoint and start of the prediction window. A prediction window either started immediately after the prediction timepoint (no lag) or was lagged by 1 day, 3 days, 1 week, or 2 weeks.](../figures/methods.png){#fig-method width=331}\n:::\n:::\n\n\n\n\n\n## Figure 2: Posterior probability for auROC by model and demographic group differences\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nfig_2a <- test_metrics_all_pp_perf |>\n  mutate(model_numeric = case_when(model == \"336 lag\" ~ as.numeric(336),\n                                   model == \"168 lag\" ~ as.numeric(168),\n                                   model == \"72 lag\" ~ as.numeric(72),\n                                   model == \"24 lag\" ~ as.numeric(24),\n                                   model == \"0 lag\" ~ as.numeric(0))) |> \n  ggplot() + \n  geom_point(aes(x = model_numeric, y = pp_median), color = \"black\") +\n  geom_line(aes(x = model_numeric, y = pp_median)) +\n  geom_segment(mapping = aes(x = model_numeric, y = pp_lower, yend = pp_upper)) +\n  scale_y_continuous(\"auROC\", limits = c(.50, 1.0)) +\n  scale_x_continuous(\"Model Lag\", breaks = c(0, 24, 72, 168, 336), \n                     labels = c(\"No lag\", \"1 day\", \"3 days\", \"1 week\",\n                                \"2 weeks\")) +\n  theme_classic() +\n  theme(legend.position = \"none\",\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1)) +\n  geom_hline(yintercept = 0.5, linetype = \"dashed\", color = \"black\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npp_dem <- pp_dem |>\n  mutate(contrast = factor(model, levels = c(\"not white\", \n                                             \"non-hispanic white\",\n                                             \"female\",\n                                             \"male\",\n                                             \"below poverty\",\n                                             \"above poverty\"),\n                           labels = c(\"Not White vs. Non-Hispanic White\",\n                                      \"Not White vs. Non-Hispanic White\",\n                                      \"Female vs. Male\",\n                                      \"Female vs. Male\",\n                                      \"Below Poverty vs. Above Poverty\",\n                                      \"Below Poverty vs. Above Poverty\")),\n         group = factor(model, levels = c(\"non-hispanic white\",\n                                          \"not white\", \n                                          \"female\",\n                                          \"male\",\n                                          \"below poverty\",\n                                          \"above poverty\"),\n                        labels = c(\"advantaged group (non-Hispanic White, male, above poverty)\", \n                                   \"disadvantaged group (not White, female, below poverty)\",\n                                   \"disadvantaged group (not White, female, below poverty)\",\n                                   \"advantaged group (non-Hispanic White, male, above poverty)\",\n                                   \"disadvantaged group (not White, female, below poverty)\",\n                                   \"advantaged group (non-Hispanic White, male, above poverty)\"))) \n\npp_dem_a <- pp_dem |> \n  filter(contrast == \"Not White vs. Non-Hispanic White\" & lag %in% c(0, 336)) |> \n  mutate(lag = factor(lag),\n         contrast = \"Race/Ethnicity\") |> \n  ggplot() + \n  geom_point(aes(x = lag, y = pp_median, color = group)) +\n  geom_segment(mapping = aes(x = lag, y = pp_lower, yend = pp_upper, color = group)) +\n  facet_wrap(~ contrast) +\n  scale_y_continuous(\"auROC\", limits = c(.35, 1.0)) +\n  scale_x_discrete(NULL, labels = c(\"No lag\", \"2 weeks\")) +\n  theme_classic() +\n  theme(panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1)) +\n  scale_color_manual(values = c(\"#240e31\", \"#cb6bce\")) +\n  geom_hline(yintercept = 0.5, linetype = \"dashed\", color = \"black\") +\n  labs(color = NULL)\n\npp_dem_b <- pp_dem |> \n  filter(contrast == \"Female vs. Male\" & lag %in% c(0, 336)) |> \n  mutate(lag = factor(lag),\n         contrast = \"Sex at birth\") |> \n  ggplot() + \n  geom_point(aes(x = lag, y = pp_median, color = group)) +\n  geom_segment(mapping = aes(x = lag, y = pp_lower, yend = pp_upper, color = group)) +\n  facet_wrap(~ contrast) +\n  scale_y_continuous(NULL, limits = c(.35, 1.0)) +\n  scale_x_discrete(\"Model Lag\", labels = c(\"No lag\", \"2 weeks\")) +\n  theme_classic() +\n  theme(panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1)) +\n  scale_color_manual(values = c(\"#240e31\", \"#cb6bce\")) +\n  geom_hline(yintercept = 0.5, linetype = \"dashed\", color = \"black\") +\n  labs(color = NULL)\n\npp_dem_c <- pp_dem |> \n  filter(contrast == \"Below Poverty vs. Above Poverty\" & lag %in% c(0, 336)) |> \n  mutate(lag = factor(lag),\n         contrast = \"Income\") |> \n  ggplot() + \n  geom_point(aes(x = lag, y = pp_median, color = group)) +\n  geom_segment(mapping = aes(x = lag, y = pp_lower, yend = pp_upper, color = group)) +\n  facet_wrap(~ contrast) +\n  scale_y_continuous(NULL, limits = c(.35, 1.0)) +\n  scale_x_discrete(NULL, labels = c(\"No lag\", \"2 weeks\")) +\n  theme_classic() +\n  theme(panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1)) +\n  scale_color_manual(values = c(\"#240e31\", \"#cb6bce\")) +\n  geom_hline(yintercept = 0.5, linetype = \"dashed\", color = \"black\") +\n  labs(color = NULL)\n\nfig_2b <- pp_dem_a + pp_dem_b + pp_dem_c + plot_layout(guides = \"collect\") &\n  theme(legend.position = \"bottom\", legend.direction = \"vertical\") \n\nfig_2 <- (fig_2a / fig_2b) &\n  plot_annotation(tag_levels = \"A\")\n```\n:::\n\n::: {#cell-fig-2 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-2\n#| fig-cap: \"Panel A displays the median posterior probability for area under ROC curve (auROC) and 95% Bayesian credible intervals (CI) for each lagged model (0, 1-day, 3-day, 1-week, and 2-week lag). Dashed line represents a random classifier with an auROC of .5. Panels B-D display the median auROC and Bayesian CI for the 0 and 2-week lag models by fairness contrast. The darker lines represent the advantaged groups (non-Hispanic White, male, above poverty) and the lighter lines represent the disadvantaged groups (not White, female, below poverty). Dashed lines represent a random classifier with an auROC of .5.\"\n#| fig-width: 8\n#| fig-height: 6\n\nfig_2 \n```\n\n::: {.cell-output-display}\n![Panel A displays the median posterior probability for area under ROC curve (auROC) and 95% Bayesian credible intervals (CI) for each lagged model (0, 1-day, 3-day, 1-week, and 2-week lag). Dashed line represents a random classifier with an auROC of .5. Panels B-D display the median auROC and Bayesian CI for the 0 and 2-week lag models by fairness contrast. The darker lines represent the advantaged groups (non-Hispanic White, male, above poverty) and the lighter lines represent the disadvantaged groups (not White, female, below poverty). Dashed lines represent a random classifier with an auROC of .5.](mak_figures_files/figure-html/fig-2-1.png){#fig-2 width=768}\n:::\n:::\n\n\n\n\n## Figure 3: Global and Local Shapley Plots\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nglobal_panel <- global_all |>\n  ggplot() +\n  geom_bar(aes(x = variable_grp, y = mean_value, fill = model), \n           stat = \"identity\", position = \"dodge\") +\n  labs(y = \"Mean(|Shapley Value|)\",\n       x = NULL,\n       fill = NULL) +\n  scale_fill_manual(values = c(\"#458892\", \"#751c6d\")) +\n  theme(axis.text=element_text(size=9.5),\n        legend.key.size = unit(0.25, \"cm\"),\n        panel.border = element_rect(colour = \"black\", fill = NA, linewidth = 1),\n        legend.position = \"right\") +\n  coord_flip()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nshap_feat_0 <- read_rds(here::here(path_models_lag, \n                                   \"outer_shapsgrp_1day_0_v3_nested_main.rds\")) |> \n  filter(str_detect(variable_grp, \"EMA\")) |> \n  mutate(variable_grp = str_remove(variable_grp, \"\\\\(EMA item\\\\)\"),\n         variable_grp = factor(variable_grp, levels = shap_levels)) |> \n  group_by(variable_grp) |> \n  summarize(min(value), max(value)) |> \n  mutate(model = \"No lag\")\n\nshap_feat_336 <- read_rds(here::here(path_models_lag, \n                                     \"outer_shapsgrp_1day_336_v3_nested_main.rds\")) |> \n  filter(str_detect(variable_grp, \"EMA\")) |> \n  mutate(variable_grp = str_remove(variable_grp, \"\\\\(EMA item\\\\)\"),\n         variable_grp = factor(variable_grp, levels = shap_levels))  |> \n  group_by(variable_grp) |> \n  summarize(min(value), max(value)) |> \n  mutate(model = \"2 weeks\")\n\npanel_shap_local <- shap_feat_0 |>\n  bind_rows(shap_feat_336) |> \n  mutate(model = factor(model, levels = c(\"2 weeks\", \"No lag\"))) |> \n  rename(min = `min(value)`,\n         max = `max(value)`) |> \n  ggplot() +\n  geom_segment(aes(x = variable_grp, y = min, yend = max, group = model,\n                   color = model),\n               position = position_dodge(width = .5), \n               linewidth = 1) +\n  ylab(\"Raw Shapley Value\") +\n  xlab(NULL) +\n  labs(color = NULL) +\n  scale_color_manual(values = c(\"#458892\", \"#751c6d\")) +\n  theme(legend.position = \"none\",\n        axis.text=element_text(size=9.5),\n        panel.border = element_rect(colour = \"black\", fill = NA, \n                                    linewidth = 1))+\n  geom_hline(aes(yintercept = 0), linetype = \"dashed\",\n             linewidth = .5) +\n  scale_y_continuous(limits = c(-2, 6), breaks = seq(-2, 6, 2)) +\n  coord_flip()\n```\n:::\n\n::: {#cell-fig-3 .cell}\n\n```{.r .cell-code .hidden}\n#| label: fig-3\n#| fig-cap: \"Panel A displays the global importance (mean |Shapley value|) for feature categories for the no lag and 2-week lag models. Feature categories are ordered by their aggregate global importance. The importance of each feature category for each model is displayed separately by color. Panels B displays the variation in local feature importance for the no lag and 2-week lag models. Lines start at minimum Shapley value and end at maximum Shapley value.\"\n#| fig-width: 8\n#| fig-height: 5\n\nglobal_panel + panel_shap_local + \n  plot_layout(guides = \"collect\") &\n  plot_annotation(tag_levels = \"A\") \n```\n\n::: {.cell-output-display}\n![Panel A displays the global importance (mean |Shapley value|) for feature categories for the no lag and 2-week lag models. Feature categories are ordered by their aggregate global importance. The importance of each feature category for each model is displayed separately by color. Panels B displays the variation in local feature importance for the no lag and 2-week lag models. Lines start at minimum Shapley value and end at maximum Shapley value.](mak_figures_files/figure-html/fig-3-1.png){#fig-3 width=768}\n:::\n:::",
    "supporting": [
      "mak_figures_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}